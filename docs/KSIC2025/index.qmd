---
title: "통계를 배우자!: Group Differences Adjustment in Observational Studies"
author: "김진섭"
date: "2025-01-18"
format:
  revealjs: 
    theme: zarathu_theme.scss
    title-slide-attributes:
      data-background-image: bg.png
      data-background-size: cover
      data-background-opacity: "0.3"
    logo: Zarathu Circle Clipping Mask2.png
    footer: "zarathu.com"
    self-contained: false
    chalkboard: 
      buttons: false
    preview-links: true
    show-notes: false
    slide-number: false
    width: 1600
    height: 900
editor: visual
subtitle: "Zarathu Co., Ltd"
---

## 자기소개

회사: 차라투 주식회사(Zarathu Co.,Ltd)

-   R 활용 의학연구지원
-   R 패키지 개발 및 교육

경력

-   의학사, 성균관대학교 (\~2009)
-   예방의학전문의/박사수료,서울대보건대학원 (\~2013)
-   책임, 삼성전자 DMC연구소/무선사업부 (\~2016)
-   대표, 차라투 (2018\~)

**jinseob2kim\@gmail.com, github.com/jinseob2kim**

## Executive summary

**Baseline 맞춘다(X), RCT를 모방한다(O)**

- ATE(average treatment effect) vs ATT(average treatment effect on treated)

- Matching은 ATT, IPTW는 ATE

**2그룹 `MatchIt`, 3그룹 `twang` 패키지** 

- Logistic regression, Nearest neighbor, caliper 이해 

- 3그룹 matching은 가장 작은 N수에 맞춰 2번 수행

- openstat.ai 에서 2그룹 matching/IPTW 지원


**분석 이슈** 

- Matching 후 pair정보 이용해야 하는가?(ex: stratified cox)

- 성별에 따라 매칭/IPTW 해도 되는가?


## Causal inference

목표는 Causal inference, RCT like design 

- $ITE = Y_{1i} - Y_{0i}$, 하늘만이..

- $ATE = E[Y_1 - Y_0]$, **RCT**

- $ATT = E[Y_1 - Y_0 | T=1]$, $ATC = E[Y_1 - Y_0 | T=0]$


## PS matching

Propensity score란?

- 치료군 vs 대조군 연구에서, age/sex/기저질환 등의 변수를 이용하여 치료군에 속할 확률을 계산한 값
- 같은 PS 면 치료군에 속할 확률이 동일 
- 같은 PS면 age/sex/기저질환 이 비슷
- 치료/대조군을 1/0으로 코딩하여 Logistic regression(다른 것도 가능)
- 치료군이 더 많다면 치료군을 0, 대조군을 1로 코딩

따라서, **치료군의 PS와 비슷한 사람을 대조군에서 뽑으면** 두 그룹의 Baseline이 비슷해지겠군!

- 여기까지 알면 50점 


## RCT 관점

RCT: 어떤 사람이 두 군에 배정될 확률이 50:50 

PS matching: PS가 0.7인 사람이 두 군에 배정될 확률? 50:50 

- PS 0.7인 사람이 치료군에 있다면, 대조군에서도 맞춰서 뽑았을 것임
- 여기까지 알면 90점 


**그럼 PS matching하면 RCT만큼 인정받을 수 있다?**

- **No**
- 치료군과 동일 특성을 가진 대조군이 매칭되므로, 연구집단 전체가 치료군의 특성을 가짐(예: 더 고령/ 남자가 많다 등)
- ATE(average treatment effect) 가 아님, **ATT(average treatment effect on the treated)**. 



## IPTW

Inverse probability of treatment weighting

- 매칭 안하고 모든 샘플을 씀. 단 각 사람마다 가중치가 다름
- A는 1명이지만 2명처럼 간주, B는 1명이지만 10명처럼 간주
- 사람별 가중치를 조절하면 Baseline을 동일하게 맞출 수 있음
- 치료군엔 $1/PS$, 대조군엔 $1/(1-PS)$ 로 가중치 부여 
- 여기까지 알면 50점



## RCT 관점 

PS 0.7인 사람이 각 군에 속할 확률은?

- 치료군 0.7, 대조군 0.3

$$0.7 \times \frac{1}{0.7} = 0.3 \times \frac{1}{0.3} = 1$$  

- 따라서 PS 0.7인 사람이 치료군과 대조군에 동일하게 분포


그럼 IPTW는 ATE vs ATT?


## ATE weight, ATT weight

ATE weight

 $$
    w_i \text{ for } ATE=
    \begin{cases}
    \frac{1}{p_i} & \text{if treated} \\
    \frac{1}{1 - p_i} & \text{if control}
    \end{cases}
    $$
전체 샘플(Treated + Control) 의 2배를 랜덤하게 배정한 RCT

ATT weight

   $$
    w_i \text{ for } ATT =
    \begin{cases}
    1 & \text{if treated} \\
    \frac{p_i}{1 - p_i} & \text{if control}
    \end{cases}
    $$
Treated + Treated 를 랜덤하게 배정



## [ATT& ATE]{style="color:navy;"}

-   ATE(Average Treatment Effect): **전체 환자 집단**(코호트)에서 **TAVI**가 **수술** 에 비해 효과적인가?
-   대조군(Surgery)와 TAVI군의 baseline을 가중치를 주어 **전체 코호트(AS 환자군)와 양군을 유사하게 만들어**, 전체 코호트에서 RCT를 진행하였을 때 예상되는 결과를 모사 
    $$
    w_i =
    \begin{cases}
    \frac{1}{p_i} & \text{if treated TAVI} \\
    \frac{1}{1 - p_i} & \text{if  (Surgery)}
    \end{cases}
    $$



## [TAVI vs Surgery: Example data]{style="color:navy;"}

```{r}
library(dplyr)
library(knitr)
df <- data.frame(
  name = c("빈센조", "루카스", "제이슨", "토마스", "리오넬",
           "카밀라", "아칸지", "에밀리", "노이어", "호날두",
           "앨리스", "밥", "찰리", "다니엘", "엘리자베스",
           "프랭크", "그레이스", "헨리", "이사벨", "제임스",
           "존", "마리아", "피터", "사라", "데이비드",
           "제니퍼", "케빈", "레베카", "토니", "엘리",
           "스티브", "안나", "마이클", "제시카", "댄",
           "소피아", "브라이언", "나탈리", "대니얼", "엘레나",
           "로버트", "줄리아", "스콧", "니콜", "앤드류",
           "케이트", "라이언", "미셸", "조셉", "엘레나"),
  age = c(35, 48, 50, 53, 55,
          68, 70, 75, 80, 85,
          40, 45, 52, 60, 62,
          67, 73, 77, 82, 88,
          42, 49, 54, 59, 61,
          46, 51, 76, 81, 83,
          37, 47, 51, 68, 84,
          59, 62, 78, 84, 89,
          39, 46, 53, 77, 75,
          54, 59, 86, 88, 83),
  TAVI = c(1, 0, 0, 1, 0,
           1, 1, 0, 1, 1,
           0, 0, 0, 1, 1,
           0, 1, 0, 1, 1,
           0, 0, 1, 1, 0,
           0, 1, 0, 1, 1,
           1, 0, 0, 1, 1,
           0, 1, 0, 1, 1,
           0, 0, 0, 1, 1,
           0, 1, 0, 1, 1),
  Survival = c(1, 1, 1, 0, 1,
               1, 1, 1, 0, 0,
               1, 1, 0, 0, 1,
               1, 1, 1, 0, 0,
               1, 1, 0, 0, 1,
               1, 1, 1, 0, 0,
               1, 1, 1, 0, 1,
               1, 1, 1, 0, 0,
               1, 1, 0, 0, 1,
               1, 1, 1, 0, 0)
)
model <- glm(TAVI ~ age, data = df, family = binomial)
df$Propensity_score <- predict(model, type = "response")

rmarkdown::paged_table(df)
```

## [ATT& ATE]{style="color:navy;"}

```{r}
library(knitr)
library(kableExtra)
df<- df %>%
  mutate(
    ATE = ifelse(TAVI == 1, 1 / Propensity_score, 1 / (1 - Propensity_score)),
    ATT = ifelse(TAVI == 1, 1, Propensity_score / (1 - Propensity_score))
  )

a<- df %>%
  select(name, age, TAVI, Survival, Propensity_score, ATE, ATT) %>%
  kable("html") %>%
    kable_styling(
    full_width = FALSE,       
    position = "center",      
    font_size = 20            
  ) %>%
  row_spec(which(df$name == "빈센조"), background = "yellow") %>% 
  row_spec(which(df$name == "에밀리"), background = "skyblue") 
a

```

## [ATT& ATE]{style="color:navy;"}

```{r}
att_group <- df %>%
  mutate(weight = ATT) %>%
  group_by(TAVI) %>%
  summarise(
    avg_age = weighted.mean(age, weight),
    sd = sqrt(weighted.mean((age - weighted.mean(age, weight))^2, weight))
  )


ate_group <- df %>%
  mutate(weight = ATE) %>%
  group_by(TAVI) %>%
  summarise(
    avg_age = weighted.mean(age, weight),
    sd = sqrt(weighted.mean((age - weighted.mean(age, weight))^2, weight))
  )

original_cohort <- df %>%
  group_by(TAVI) %>% 
  summarise(
    avg_age = mean(age),
    sd = sd(age)
  )
num<-mean(df$age)%>% round(., digits = 2)
baseline_table <- data.frame(
  그룹 = c("ATT", "ATE", "Original Cohort"),
  Treatment = c(att_group$avg_age[att_group$TAVI == 1] %>% round(., digits = 2),
               ate_group$avg_age[ate_group$TAVI == 1]%>% round(., digits = 2),
               paste0(original_cohort$avg_age[original_cohort$TAVI ==1]%>% round(., digits = 2), '(',num, ')')),
  Control = c(att_group$avg_age[att_group$TAVI == 0]%>% round(., digits = 2),
              ate_group$avg_age[ate_group$TAVI == 0]%>% round(., digits = 2),
              paste0(original_cohort$avg_age[original_cohort$TAVI ==0]%>% round(., digits = 2), '(', num, ')'))
)

kable(baseline_table, "html", caption = "Treatment, Control 그룹의 Age 비교") %>%
  kable_styling(full_width = T)

```


## IPTW win? 

IPTW는 ATE니까 무조건 이걸해야겠네?

- Weight 100 인 사람이 있다면? 

Truncated weight

- 99% quantile 값 이상은 99%로 바꿈 
- weight 10 이상은 10으로 바꿈
- Baseline 이 덜 맞춰지게 됨, ATE 훼손

분석난이도 증가

- GLM, Cox에 Weight를 고려 (`glm`, `cox` weights 옵션 또는 `svyglm`, `svycox`)

- Weighted Kaplan-meier from svycox (`survfit` weights 옵션 또는 `svykm`)

##

```{r, echo=F}
library(survey)
data(pbc, package = "survival")
pbc$randomized <- with(pbc, !is.na(trt) & trt > 0)
biasmodel <- glm(randomized ~ age * edema, data = pbc)
pbc$randprob <- fitted(biasmodel)

dpbc <- svydesign(id = ~1, prob = ~randprob, strata = ~edema, data = subset(pbc, randomized))
```

```{r, echo=T}
s1 <- svykm(Surv(time, status > 0) ~ sex, design = dpbc)
jskm::svyjskm(s1, pval = T, table = T, design = dpbc)
```

log-rank test(X), survey rank test(O)




## 日本ブログレビュー

::: columns
::: {.column width="50%"}
![](jskm_japan.png)
:::

::: {.column width="50%"}
![](jskm_japan2.png)
:::
:::

Survey data, Landmark, Competing risk analysis support

::: notes
特に日本の研究者の方がランドマーク分析機能をたくさん利用してくださって、ブログレビューがたくさんあります。 토쿠니 니혼노 켄큐우샤노 호오가 란도마아쿠분세키키노오오 타쿠산 리요오시테쿠다삿테 부로구레뷰우가 타쿠산 아리마스
:::

## 

<center><a href="https://github.com/jinseob2kim/jstable"><img src="jstable.png" width="100%"/></a></center>

::: columns
::: {.column width="50%"}
``` r
## Gaussian
glm_gaussian <- glm(mpg~cyl + disp, data = mtcars)
glmshow.display(glm_gaussian, decimal = 2)
```

``` r
$first.line
[1] "Linear regression predicting mpg\n"

$table
     crude coeff.(95%CI)   crude P value adj. coeff.(95%CI)    adj. P value
cyl  "-2.88 (-3.51,-2.24)" "< 0.001"     "-1.59 (-2.98,-0.19)" "0.034"
disp "-0.04 (-0.05,-0.03)" "< 0.001"     "-0.02 (-0.04,0)"     "0.054"

$last.lines
[1] "No. of observations = 32\nR-squared = 0.7596\nAIC value = 167.1456\n\n"
```
:::

::: {.column width="50%"}
``` r
## Binomial
glm_binomial <- glm(vs~cyl + disp, data = mtcars, family = binomial)
glmshow.display(glm_binomial, decimal = 2)
```

``` r
$first.line
[1] "Logistic regression predicting vs\n"
 
$table
     crude OR.(95%CI)   crude P value adj. OR.(95%CI)    adj. P value
cyl  "0.2 (0.08,0.56)"  "0.002"       "0.15 (0.02,1.02)" "0.053"     
disp "0.98 (0.97,0.99)" "0.002"       "1 (0.98,1.03)"    "0.715"     

$last.lines
[1] "No. of observations = 32\nAIC value = 23.8304\n\n"
```
:::
:::

## Subgroup analysis

``` r
TableSubgroupMultiGLM(status ~ sex, var_subgroups = c("kk", "kk1"), data = lung, family = "binomial")
```

``` r
    Variable Count Percent           OR Lower Upper P value P for interaction
sex2  Overall   228     100         3.01  1.65  5.47  <0.001              <NA>
1          kk  <NA>    <NA>         <NA>  <NA>  <NA>    <NA>             0.476
2           0    38    16.9            7   0.7 70.03   0.098              <NA>
3           1   187    83.1         2.94  1.55  5.57   0.001              <NA>
4         kk1  <NA>    <NA>         <NA>  <NA>  <NA>    <NA>             0.984
5           0     8     3.6 314366015.19     0   Inf   0.997              <NA>
6           1   217    96.4         2.85  1.55  5.25   0.001              <NA>
```

``` r
TableSubgroupMultiCox(Surv(time, status) ~ sex, var_subgroups = c("kk", "kk1"), data = lung)
```

``` r
    Variable Count Percent Point Estimate Lower Upper sex=1 sex=2 P value P for interaction
sex  Overall   228     100           1.91  1.14   3.2   100   100   0.014              <NA>
1       <NA>  <NA>    <NA>           <NA>  <NA>  <NA>  <NA>  <NA>    <NA>              <NA>
2         kk  <NA>    <NA>           <NA>  <NA>  <NA>  <NA>  <NA>    <NA>             0.525
3          0    38    16.9           2.88  0.31 26.49    10   100    0.35              <NA>
4          1   187    83.1           1.84  1.08  3.14   100   100   0.026              <NA>
5       <NA>  <NA>    <NA>           <NA>  <NA>  <NA>  <NA>  <NA>    <NA>              <NA>
6        kk1  <NA>    <NA>           <NA>  <NA>  <NA>  <NA>  <NA>    <NA>             0.997
7          0     8     3.6           <NA>  <NA>  <NA>     0   100    <NA>              <NA>
8          1   217    96.4           1.88  1.12  3.17   100   100   0.018              <NA>
```

## 中国での動画やブログレビュー

::: columns
::: {.column width="50%"}
![](jstable_ch.png)
:::

::: {.column width="50%"}
![](jstable_ch2.png)
:::
:::

## 

<center><a href="https://github.com/jinseob2kim/jsmodule"><img src="jsmodule.png" width="100%"/></a></center>

::: columns
::: {.column width="50%"}
![](https://github.com/jinseob2kim/jsmodule/blob/master/vignettes/figures/ps.png?raw=true)
:::

::: {.column width="50%"}
1\~2行のコードだけで分析ウェブを作れるよう、各分析機能をmoduleとして開発

![](jsmodule2.png)
:::
:::

::: notes
마지막으로 jsmodule입니다. jskm, jstable 내용을 포함해 의학통계에서 많이 이용되는 분석기능들을 Shiny module로 만들고, 이 모듈들을 모아 로컬에서 실행할 수 있는 Shiny App 을 만들었습니다. Shiny App은 총 5종류로 일반데이터용, Survey data용, GEE를 적용한 반복측정데이터용, 마지막으로 인과추론 분석방법인 Propensity score mathching과 IPTW 를 수행할 수 있는 Shiny App 입니다. 각 분석기능은 독립적으로 Shiny module로 개발되었으므로, 누구나 자신의 Shiny app에 적용할 수 있습니다.
:::

## 

![](그림1.png)

::: notes
이것은 jskm을 Shiny module로 만든 것이며, 그림은 PPT로 다운받아 직접 편집할 수 있습니다. officer과 rvg 패키지를 이용했습니다.
:::

## 論文支援実績

SCI論文200編以上サポート

-   医学分野 トップジャーナル NEJM、LANCET、JAMAを含む
-   6つの大学病院と年単位研究支援契約、10ヶ所の製薬会社の臨床試験分析をサポート

![](그림2.png)

::: notes
저희 회사에서는 이 패키지들을 이용해 의학연구를 지원하고 있으며, 세계 3대 의학저널인 NEJM, LANCET, JAMA 포함 200편 이상의 SCI 논문에 필요한 분석을 지원하였습니다. 한국의 6개 대학병원과 연단위 계약을 수행중이며, 10개이상 제약회사의 임상시험 데이터분석을 지원중입니다.
:::

## 無料統計ウェブ

-   よく利用される分析機能を無料で分析できるopenstat.ai 公開
-   jskm/jstable/jsmoduleの分析moduleを適用

::: columns
::: {.column width="70%"}
[**openstat.ai**](https://openstat.ai/)**: free**

![](example-meta.png)
:::

::: {.column width="30%"}
**Openstat QR code**

![](오픈스탯.png)
:::
:::

::: notes
연구자들이 R 패키지 설치없이도 웹에서 이용할 수 있도록 하기 위해 openstat.ai를 출시하였습니다. 연구자는 자신의 데이터를 업로드하여 jsmodule의 4가지 Shiny app을 이용할 수 있습니다. 메타분석, 샘플수계산을 위한 Shiny app도 이용할 수 있습니다.
:::

## 国家R&D選定

3件の国家R&D支援事業を通じて技術開発および医学研究用の高度化を遂行

\`22 (韓国)科学技術情報通信部「公開SW基盤のクラウド統計パッケージSW開発」(2年1億円)

-   統計非専攻者及び一般向け

\`23 (韓国)情報通信産業振興院公開SW技術拡散支援事業(7ヶ月2000万円)

-   医学研究用

\`23 (韓国)中小ベンチャー部 (1200万円)

-   医学研究用&臨床試験

::: notes
저희 패키지는 한국에서 3건의 R&D 지원을 받아 개발 및 의학연구/임상시험용 고도화를 수행하였습니다.
:::

## 著作権登録

<center><img src="jj.png" width="50%"/></a></center>

::: notes
R&D 지원을 통해 소프트웨어 저작권을 등록했으며
:::

## オープンソース管理

::: columns
::: {.column width="50%"}
https://statgarten-issue.streamlit.app/

![](metric.png)
:::

::: {.column width="50%"}
Github action

-   テスト、ホームページアップデート、ライセンス同意、コードstyle

![](ga.png)
:::
:::

::: notes
자체 개발한 파이썬 streamlit 기반 대시보드를 이용해 깃허브 활성화 정도를 실시간으로 체크할 수 있으며, 모든 패키지는 Github action을 통해 에러체크, 홈페이지 업데이트, 코드 스타일링, 라이선스 동의가 자동으로 수행됩니다.
:::

## オープンソースライセンス検証

<center><img src="license.png" width="80%"/></a></center>

::: notes
모든 패키지는 나라에서 지원하는 오픈소스라이선스검증 프로그램을 이용해, 라이선스 문제가 없음을 검증받았습니다.
:::

## R package: Shiny -\> exe

R必要なくexeファイルにしてローカル環境で実行 - [executablePackeR](https://github.com/ChangwooLim/executablePackeR)

<center><a href="https://www.r-bloggers.com/2023/03/creating-standalone-apps-from-shiny-with-electron-2023-macos-m1//"><img src="スクリーンショット 2024-04-17 午後12.02.26.png" width="50%"/></a></center>

::: notes
폐쇄 인터넷망 및 R패키지 설치가 어려운 병원들을 위해, Shiny app을 exe파일로 만들어주는 R패키지를 만들어 크랜에 공개하였습니다. 이 패키지를 이용하면 exe 파일의 실행만으로 shiny app을 이용할 수 있으며, 알블로거에도 소개되었습니다.
:::

## 要約

-   医学研究用Rパッケージの開発、日本/中国で活用

-   国家R&D選定

-   最新オープンソース管理技術

-   ライセンス検証

# ご清聴、ありがとうございました。

::: notes
ご清聴（せいちょう）ありがとうございました。
:::
